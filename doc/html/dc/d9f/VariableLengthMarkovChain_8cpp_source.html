<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ToPS: VariableLengthMarkovChain.cpp Source File</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ToPS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">VariableLengthMarkovChain.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *       VariableLengthMarkovChain.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *       Copyright 2011 Andre Yoshiaki Kashiwabara &lt;akashiwabara@usp.br&gt;</span>
<a name="l00005"></a>00005 <span class="comment"> *                      Ígor Bonádio &lt;ibonadio@ime.usp.br&gt;</span>
<a name="l00006"></a>00006 <span class="comment"> *                      Vitor Onuchic &lt;vitoronuchic@gmail.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *                      Alan Mitchell Durham &lt;aland@usp.br&gt;</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *       This program is free software; you can redistribute it and/or modify</span>
<a name="l00010"></a>00010 <span class="comment"> *       it under the terms of the GNU  General Public License as published by</span>
<a name="l00011"></a>00011 <span class="comment"> *       the Free Software Foundation; either version 3 of the License, or</span>
<a name="l00012"></a>00012 <span class="comment"> *       (at your option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> *       This program is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment"> *       but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment"> *       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment"> *       GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> *       You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment"> *       along with this program; if not, write to the Free Software</span>
<a name="l00021"></a>00021 <span class="comment"> *       Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,</span>
<a name="l00022"></a>00022 <span class="comment"> *       MA 02110-1301, USA.</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;VariableLengthMarkovChain.hpp&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;VariableLengthMarkovChainCreator.hpp&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;Symbol.hpp&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;boost/algorithm/string.hpp&gt;</span>
<a name="l00029"></a>00029 <span class="keyword">namespace </span>tops {
<a name="l00030"></a>00030 
<a name="l00031"></a>00031     std::string VariableLengthMarkovChain::print_graph ()<span class="keyword"> const </span>{
<a name="l00032"></a>00032         std::stringstream out;
<a name="l00033"></a>00033         AlphabetPtr <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a> = <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">ProbabilisticModel::alphabet</a>();
<a name="l00034"></a>00034         <span class="keywordtype">int</span> nnodes = _tree-&gt;getNumberOfNodes();
<a name="l00035"></a>00035         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nnodes; i++) {
<a name="l00036"></a>00036             ContextTreeNodePtr current = _tree-&gt;getContext(i);
<a name="l00037"></a>00037             ContextTreeNodePtr root = _tree-&gt;getRoot();
<a name="l00038"></a>00038             std::vector &lt;std::string&gt; aux;
<a name="l00039"></a>00039             <span class="keywordflow">while</span>(current != root) {
<a name="l00040"></a>00040                 aux.push_back(alphabet-&gt;getSymbol(current-&gt;symbol())-&gt;name() );
<a name="l00041"></a>00041                 current = _tree-&gt;getContext(current-&gt;getParent());
<a name="l00042"></a>00042             }
<a name="l00043"></a>00043             std::stringstream node_id;
<a name="l00044"></a>00044             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = aux.size() - 1; j &gt;= 0; j--)
<a name="l00045"></a>00045                 node_id  &lt;&lt; aux[j] ;
<a name="l00046"></a>00046             out &lt;&lt; _tree-&gt;getContext(i)-&gt;id() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt;  node_id.str() &lt;&lt; std::endl;
<a name="l00047"></a>00047         }
<a name="l00048"></a>00048         out &lt;&lt; <span class="stringliteral">&quot;#&quot;</span> &lt;&lt; std::endl;
<a name="l00049"></a>00049         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nnodes; i++) {
<a name="l00050"></a>00050             out &lt;&lt; _tree-&gt;getContext(i)-&gt;id() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt;  _tree-&gt;getContext(_tree-&gt;getContext(i)-&gt;getParent())-&gt;<span class="keywordtype">id</span>()  &lt;&lt; std::endl;
<a name="l00051"></a>00051         }
<a name="l00052"></a>00052         <span class="keywordflow">return</span> out.str();
<a name="l00053"></a>00053     }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a>00056   <span class="keywordtype">void</span> VariableLengthMarkovChain::printDistribution(ContextTreePtr tree, ContextTreeNodePtr node, std::stringstream &amp; out, AlphabetPtr alphabet)<span class="keyword"> const </span>{
<a name="l00057"></a>00057     ContextTreeNodePtr current = node;
<a name="l00058"></a>00058     std::vector &lt;std::string&gt; aux;
<a name="l00059"></a>00059     <span class="keywordtype">bool</span> root=<span class="keyword">true</span>;
<a name="l00060"></a>00060     <span class="keywordflow">if</span>(current != tree-&gt;getRoot() )
<a name="l00061"></a>00061       root = <span class="keyword">false</span>;
<a name="l00062"></a>00062     <span class="keywordflow">while</span>(current != tree-&gt;getRoot())
<a name="l00063"></a>00063       {
<a name="l00064"></a>00064         aux.push_back(alphabet-&gt;getSymbol(current-&gt;symbol())-&gt;name() );
<a name="l00065"></a>00065         current = tree-&gt;getContext(current-&gt;getParent());
<a name="l00066"></a>00066       }
<a name="l00067"></a>00067     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 0; k &lt; (int)alphabet-&gt;size(); k++)
<a name="l00068"></a>00068       {
<a name="l00069"></a>00069         out &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; alphabet-&gt;getSymbol(k)-&gt;name() &lt;&lt; <span class="stringliteral">&quot;\&quot; | &quot;</span> ;
<a name="l00070"></a>00070         <span class="keywordflow">if</span>(root)
<a name="l00071"></a>00071           out &lt;&lt; <span class="stringliteral">&quot;\&quot;\&quot; &quot;</span> ;
<a name="l00072"></a>00072         <span class="keywordflow">else</span>
<a name="l00073"></a>00073           {
<a name="l00074"></a>00074             out &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span>;
<a name="l00075"></a>00075             out &lt;&lt; aux[aux.size() -1];
<a name="l00076"></a>00076             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = aux.size()-2; i &gt;=0; i--)
<a name="l00077"></a>00077               out &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; aux[i] ;
<a name="l00078"></a>00078             out &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span>;
<a name="l00079"></a>00079           }
<a name="l00080"></a>00080         out &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> ;
<a name="l00081"></a>00081         out &lt;&lt; exp(node-&gt;getDistribution()-&gt;log_probability_of(k)) &lt;&lt; <span class="stringliteral">&quot;;&quot;</span>;
<a name="l00082"></a>00082         <span class="keywordflow">if</span>(node-&gt;isLeaf())
<a name="l00083"></a>00083           out &lt;&lt; <span class="stringliteral">&quot; # leaf&quot;</span>;
<a name="l00084"></a>00084         out &lt;&lt; std::endl;
<a name="l00085"></a>00085       }
<a name="l00086"></a>00086     <span class="keywordflow">if</span>(!node-&gt;isLeaf())
<a name="l00087"></a>00087       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = 0; l &lt; node-&gt;alphabet_size(); l++)
<a name="l00088"></a>00088         <span class="keywordflow">if</span>(node-&gt;getChild(l) != NULL)
<a name="l00089"></a>00089           printDistribution(tree, node-&gt;getChild(l), out, <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>);
<a name="l00090"></a>00090   }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a23cdd1e528bf23f2562ac4396f7a8d4e">00093</a>   <span class="keywordtype">double</span> <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a23cdd1e528bf23f2562ac4396f7a8d4e" title="Evaluate the position i of the sequence s.">VariableLengthMarkovChain::evaluatePosition</a>(<span class="keyword">const</span> Sequence &amp; s, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i)<span class="keyword">const</span>{
<a name="l00094"></a>00094     ContextTreeNodePtr c = _tree-&gt;getContext(s,i);
<a name="l00095"></a>00095     <span class="keywordflow">if</span> (c == NULL)
<a name="l00096"></a>00096       <span class="keywordflow">return</span> -HUGE;
<a name="l00097"></a>00097     <span class="keywordflow">else</span>
<a name="l00098"></a>00098       <span class="keywordflow">return</span> c-&gt;getDistribution()-&gt;evaluatePosition(s,i);
<a name="l00099"></a>00099   }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a7b9eef27d757434732fdb0a6e3d072e3">00101</a>   <span class="keywordtype">double</span> <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a7b9eef27d757434732fdb0a6e3d072e3" title="Choose the position i of the sequence s given the subsequence before the position i...">VariableLengthMarkovChain::choosePosition</a>(<span class="keyword">const</span> Sequence &amp; s, <span class="keywordtype">int</span> i)<span class="keyword">const</span>{
<a name="l00102"></a>00102     ContextTreeNodePtr c = _tree-&gt;getContext(s,i);
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (c == NULL)
<a name="l00104"></a>00104       <span class="keywordflow">return</span> -HUGE;
<a name="l00105"></a>00105     <span class="keywordflow">else</span>
<a name="l00106"></a>00106       <span class="keywordflow">return</span> c-&gt;getDistribution()-&gt;choosePosition(s,i);
<a name="l00107"></a>00107   }
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a8a8ade533b01e577212a174d694f1e26">00109</a>   ProbabilisticModelCreatorPtr <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a8a8ade533b01e577212a174d694f1e26" title="Returns a factory for this Markov chain.">VariableLengthMarkovChain::getFactory</a>()<span class="keyword"> const </span>{
<a name="l00110"></a>00110     <span class="keywordflow">return</span> VariableLengthMarkovChainCreatorPtr (<span class="keyword">new</span> <a class="code" href="../../dd/d33/classtops_1_1VariableLengthMarkovChainCreator.html" title="This class is a factory for the variable length markov chain.">VariableLengthMarkovChainCreator</a>());
<a name="l00111"></a>00111   }
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#ab990dd717eaa74430defb6b782aeb98e">00113</a>   <span class="keywordtype">int</span> <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#ab990dd717eaa74430defb6b782aeb98e" title="Returns the number of parameters of the model.">VariableLengthMarkovChain::size</a>()<span class="keyword"> const </span>{
<a name="l00114"></a>00114     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;<a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#ab990dd717eaa74430defb6b782aeb98e" title="Returns the number of parameters of the model.">size</a>() -1)* _tree-&gt;getNumberOfNodes();
<a name="l00115"></a>00115   }
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a07c762d5c15b3d3d2359a4df59aa04a5">00117</a>   std::string <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a07c762d5c15b3d3d2359a4df59aa04a5" title="Returns a string representation of the model.">VariableLengthMarkovChain::str</a>()<span class="keyword"> const </span>{
<a name="l00118"></a>00118     std::stringstream out;
<a name="l00119"></a>00119     <span class="keywordflow">if</span>(_tree == NULL){
<a name="l00120"></a>00120       std::cerr &lt;&lt; <span class="stringliteral">&quot;This Markov chain model was not defined !&quot;</span> &lt;&lt; std::endl;
<a name="l00121"></a>00121       <span class="keywordflow">return</span> out.str();
<a name="l00122"></a>00122     }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     out &lt;&lt; <span class="stringliteral">&quot;model_name = \&quot;&quot;</span> &lt;&lt; <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a04f2a9328feb57ada5397c6e64d420b8" title="Returns the name of the model.">model_name</a>() &lt;&lt; <span class="stringliteral">&quot;\&quot;&quot;</span> &lt;&lt; std::endl;
<a name="l00125"></a>00125       out &lt;&lt; <span class="stringliteral">&quot;probabilities = (&quot;</span>;
<a name="l00126"></a>00126       printDistribution( _tree, _tree-&gt;getRoot(), out, <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()) ;
<a name="l00127"></a>00127       out &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; std::endl;
<a name="l00128"></a>00128       out &lt;&lt; <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;str() ;
<a name="l00129"></a>00129       <span class="keywordflow">return</span> out.str();
<a name="l00130"></a>00130   }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a290166e9081d6e0931f135b5579815b2">00132</a>   <a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html" title="This class registers a set of parameters.">ProbabilisticModelParameters</a> <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#a290166e9081d6e0931f135b5579815b2" title="Returns the parameters of the model.">VariableLengthMarkovChain::parameters</a>()<span class="keyword"> const</span>
<a name="l00133"></a>00133 <span class="keyword">  </span>{
<a name="l00134"></a>00134     <a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html" title="This class registers a set of parameters.">ProbabilisticModelParameters</a> p;
<a name="l00135"></a>00135     p.add(<span class="stringliteral">&quot;model_name&quot;</span>, StringParameterValuePtr(<span class="keyword">new</span> <a class="code" href="../d69/classtops_1_1StringParameterValue.html" title="String parameter value.">StringParameterValue</a>(<span class="stringliteral">&quot;VariableLengthMarkovChain&quot;</span>)));
<a name="l00136"></a>00136     p.add(<span class="stringliteral">&quot;probabilities&quot;</span>, _tree-&gt;getParameterValue());
<a name="l00137"></a>00137     p.add(<span class="stringliteral">&quot;alphabet&quot;</span>, <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;getParameterValue());
<a name="l00138"></a>00138     <span class="keywordflow">return</span> p;
<a name="l00139"></a>00139   }
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#ab1534dcb0eafa33cd8a868ce59d0bcc0">00141</a>   <span class="keywordtype">void</span> <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#ab1534dcb0eafa33cd8a868ce59d0bcc0" title="Initialize the Markov chain given the parameters.">VariableLengthMarkovChain::initialize</a>(<span class="keyword">const</span> <a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html" title="This class registers a set of parameters.">ProbabilisticModelParameters</a> &amp; p) {
<a name="l00142"></a>00142     ProbabilisticModelParameterValuePtr probs = p.<a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html#a60315b3775ed3b394a7b229075f5f11b" title="Get a mandatory parameter.">getMandatoryParameterValue</a>(<span class="stringliteral">&quot;probabilities&quot;</span>);
<a name="l00143"></a>00143     ProbabilisticModelParameterValuePtr symbols = p.<a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html#a60315b3775ed3b394a7b229075f5f11b" title="Get a mandatory parameter.">getMandatoryParameterValue</a>(<span class="stringliteral">&quot;alphabet&quot;</span>);
<a name="l00144"></a>00144     <span class="keywordflow">if</span>((probs == NULL) || (symbols == NULL))
<a name="l00145"></a>00145       {
<a name="l00146"></a>00146         <span class="keywordflow">return</span>;
<a name="l00147"></a>00147       }
<a name="l00148"></a>00148     AlphabetPtr alphabet = AlphabetPtr(<span class="keyword">new</span> <a class="code" href="../../d1/d60/classtops_1_1Alphabet.html" title="A class representing Alphabet.">Alphabet</a>());
<a name="l00149"></a>00149     alphabet-&gt;initializeFromVector(symbols-&gt;getStringVector());
<a name="l00150"></a>00150     ContextTreePtr tree =
<a name="l00151"></a>00151       ContextTreePtr(<span class="keyword">new</span> <a class="code" href="../../db/df5/classtops_1_1ContextTree.html" title="This class represents a context tree.">ContextTree</a>(alphabet));
<a name="l00152"></a>00152     ContextTreeNodePtr root = tree-&gt;createContext();
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     std::string  root_str(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00155"></a>00155     <a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#acb3cebd623935ef2a233906dcfcaf162" title="Set the context tree of the Markov chain.">setTree</a>(tree);
<a name="l00156"></a>00156     <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a684637528b3666ca9637fdb15ac5b37f" title="Setter for the Alphabet.">setAlphabet</a>(alphabet);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     map&lt;std::string,DoubleVector&gt; probmap;
<a name="l00159"></a>00159     std::map &lt;std::string,double&gt;::const_iterator it;
<a name="l00160"></a>00160     std::map &lt;std::string,std::vector&lt;double&gt; &gt;::const_iterator it2;
<a name="l00161"></a>00161     <span class="keywordflow">for</span>(it = (probs-&gt;getDoubleMap()).begin();
<a name="l00162"></a>00162         it !=(probs-&gt;getDoubleMap()).end();
<a name="l00163"></a>00163         it++)
<a name="l00164"></a>00164       {
<a name="l00165"></a>00165         std::vector &lt;std::string&gt; splited;
<a name="l00166"></a>00166         boost::regex separator(<span class="stringliteral">&quot;\\|&quot;</span>);
<a name="l00167"></a>00167         tops::split_regex(it-&gt;first, splited, separator);
<a name="l00168"></a>00168         <span class="keywordflow">if</span>(splited.size() == 1) {
<a name="l00169"></a>00169           splited.push_back(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         std::string context (splited[1]);
<a name="l00173"></a>00173         std::string symbol ( splited[0]);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         <span class="keywordflow">if</span>(probmap.find(context) == probmap.end())
<a name="l00176"></a>00176           {
<a name="l00177"></a>00177             <span class="keywordtype">int</span> <span class="keywordtype">id</span> = alphabet-&gt;getSymbol(symbol)-&gt;id();
<a name="l00178"></a>00178             DoubleVector probs;
<a name="l00179"></a>00179             probs.resize(alphabet-&gt;size());
<a name="l00180"></a>00180             probmap[context]=probs;
<a name="l00181"></a>00181             <span class="keywordflow">if</span>(<span class="keywordtype">id</span> &lt; (<span class="keywordtype">int</span>)probmap[context].size())
<a name="l00182"></a>00182               (probmap[context])[id] = it-&gt;second;
<a name="l00183"></a>00183           }
<a name="l00184"></a>00184         <span class="keywordflow">else</span>
<a name="l00185"></a>00185           {
<a name="l00186"></a>00186             <span class="keywordtype">int</span> <span class="keywordtype">id</span> = alphabet-&gt;getSymbol(symbol)-&gt;id();
<a name="l00187"></a>00187             <span class="keywordflow">if</span>(<span class="keywordtype">id</span> &lt; (<span class="keywordtype">int</span>)probmap[context].<a class="code" href="../../d7/d4b/classtops_1_1VariableLengthMarkovChain.html#ab990dd717eaa74430defb6b782aeb98e" title="Returns the number of parameters of the model.">size</a>())
<a name="l00188"></a>00188               (probmap[context])[<span class="keywordtype">id</span>] = it-&gt;second;
<a name="l00189"></a>00189           }
<a name="l00190"></a>00190       }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="keywordflow">for</span>(it2 = probmap.begin(); it2 != probmap.end(); it2++) {
<a name="l00193"></a>00193         std::vector &lt;std::string&gt; history;
<a name="l00194"></a>00194         std::string context = it2-&gt;first;
<a name="l00195"></a>00195         std::vector&lt;double&gt; p = it2-&gt;second;
<a name="l00196"></a>00196         boost::split(history, context, boost::is_any_of(<span class="stringliteral">&quot; &quot;</span>));
<a name="l00197"></a>00197         <span class="keywordflow">if</span>(context.size() &lt;= 0)
<a name="l00198"></a>00198           {
<a name="l00199"></a>00199             <a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html" title="This class registers a set of parameters.">ProbabilisticModelParameters</a> fddpar ;
<a name="l00200"></a>00200             fddpar.add(<span class="stringliteral">&quot;probabilities&quot;</span>, DoubleVectorParameterValuePtr(<span class="keyword">new</span> <a class="code" href="../../de/d19/classtops_1_1DoubleVectorParameterValue.html" title="double vector parameter value">DoubleVectorParameterValue</a>(p)));
<a name="l00201"></a>00201             fddpar.add(<span class="stringliteral">&quot;alphabet&quot;</span>, alphabet-&gt;getParameterValue());
<a name="l00202"></a>00202             DiscreteIIDModelPtr distr =
<a name="l00203"></a>00203               DiscreteIIDModelPtr(<span class="keyword">new</span> <a class="code" href="../../dd/dab/classtops_1_1DiscreteIIDModel.html" title="This represent probability distributions over a finite set of symbols.">DiscreteIIDModel</a>());
<a name="l00204"></a>00204             distr-&gt;initialize(fddpar);
<a name="l00205"></a>00205             root-&gt;setDistribution(distr);
<a name="l00206"></a>00206           }
<a name="l00207"></a>00207         <span class="keywordflow">else</span>
<a name="l00208"></a>00208           {
<a name="l00209"></a>00209             ContextTreeNodePtr current  = root;
<a name="l00210"></a>00210             <span class="comment">// history with indices -1, -2, -3,...</span>
<a name="l00211"></a>00211             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; (int)history.size() ;i++)
<a name="l00212"></a>00212               {
<a name="l00213"></a>00213                 <span class="keywordtype">int</span> <span class="keywordtype">id</span> = alphabet-&gt;getSymbol(history[i])-&gt;id();
<a name="l00214"></a>00214                 <span class="keywordflow">if</span>(<span class="keywordtype">id</span> &lt; 0)
<a name="l00215"></a>00215                   {
<a name="l00216"></a>00216                     std::cerr &lt;&lt; <span class="stringliteral">&quot;ERROR: Symbol, &#39;&quot;</span> &lt;&lt; history[i] &lt;&lt; <span class="stringliteral">&quot;&#39;, not in the alphabet !&quot;</span> &lt;&lt; std::endl;
<a name="l00217"></a>00217                     exit(-1);
<a name="l00218"></a>00218                   }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220                 <span class="keywordflow">if</span>(current-&gt;getChild(<span class="keywordtype">id</span>) == NULL)
<a name="l00221"></a>00221                   {
<a name="l00222"></a>00222                     ContextTreeNodePtr node2 = tree-&gt;createContext();
<a name="l00223"></a>00223                     current-&gt;setChild(node2, <span class="keywordtype">id</span>);
<a name="l00224"></a>00224                     <span class="keywordflow">if</span>(i == ((<span class="keywordtype">int</span>)history.size() - 1))
<a name="l00225"></a>00225                       {
<a name="l00226"></a>00226                         <a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html" title="This class registers a set of parameters.">ProbabilisticModelParameters</a> fddpar ;
<a name="l00227"></a>00227                         fddpar.add(<span class="stringliteral">&quot;probabilities&quot;</span>, DoubleVectorParameterValuePtr(<span class="keyword">new</span> <a class="code" href="../../de/d19/classtops_1_1DoubleVectorParameterValue.html" title="double vector parameter value">DoubleVectorParameterValue</a>(p)));
<a name="l00228"></a>00228                         fddpar.add(<span class="stringliteral">&quot;alphabet&quot;</span>, alphabet-&gt;getParameterValue());
<a name="l00229"></a>00229                         DiscreteIIDModelPtr distr =
<a name="l00230"></a>00230                           DiscreteIIDModelPtr(<span class="keyword">new</span> <a class="code" href="../../dd/dab/classtops_1_1DiscreteIIDModel.html" title="This represent probability distributions over a finite set of symbols.">DiscreteIIDModel</a>());
<a name="l00231"></a>00231                         distr-&gt;initialize(fddpar);
<a name="l00232"></a>00232                         node2-&gt;setDistribution(distr);
<a name="l00233"></a>00233                       }
<a name="l00234"></a>00234                     <span class="keywordflow">else</span>
<a name="l00235"></a>00235                       {
<a name="l00236"></a>00236                         DoubleVector probs2;
<a name="l00237"></a>00237                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; (int)alphabet-&gt;size()-1; i++)
<a name="l00238"></a>00238                           probs2.push_back(1.0/(<span class="keywordtype">double</span>)alphabet-&gt;size());
<a name="l00239"></a>00239                         <a class="code" href="../../d8/d0d/classtops_1_1ProbabilisticModelParameters.html" title="This class registers a set of parameters.">ProbabilisticModelParameters</a> fddpar ;
<a name="l00240"></a>00240                         fddpar.add(<span class="stringliteral">&quot;probabilities&quot;</span>, DoubleVectorParameterValuePtr(<span class="keyword">new</span> <a class="code" href="../../de/d19/classtops_1_1DoubleVectorParameterValue.html" title="double vector parameter value">DoubleVectorParameterValue</a>(probs2)));
<a name="l00241"></a>00241                         fddpar.add(<span class="stringliteral">&quot;alphabet&quot;</span>, alphabet-&gt;getParameterValue());
<a name="l00242"></a>00242                         DiscreteIIDModelPtr distr =
<a name="l00243"></a>00243                           DiscreteIIDModelPtr(<span class="keyword">new</span> <a class="code" href="../../dd/dab/classtops_1_1DiscreteIIDModel.html" title="This represent probability distributions over a finite set of symbols.">DiscreteIIDModel</a>());
<a name="l00244"></a>00244                         distr-&gt;initialize(fddpar);
<a name="l00245"></a>00245                         node2-&gt;setDistribution(distr);
<a name="l00246"></a>00246                       }
<a name="l00247"></a>00247                   }
<a name="l00248"></a>00248                 current = current-&gt;getChild(<span class="keywordtype">id</span>);
<a name="l00249"></a>00249               }
<a name="l00250"></a>00250           }
<a name="l00251"></a>00251       }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="keywordtype">void</span> VariableLengthMarkovChain::removeSequenceFromModel(<span class="keyword">const</span> Sequence &amp; s,  <span class="keywordtype">int</span> phase){
<a name="l00256"></a>00256       ContextTreeNodePtr c =  _tree-&gt;getRoot();
<a name="l00257"></a>00257     ContextTreeNodePtr p;
<a name="l00258"></a>00258     <span class="keywordtype">int</span> j;
<a name="l00259"></a>00259     <span class="keywordflow">for</span>(j = s.size()-2; j &gt;=0; j--){
<a name="l00260"></a>00260       <span class="keywordflow">if</span>(c-&gt;isLeaf())
<a name="l00261"></a>00261         <span class="keywordflow">break</span>;
<a name="l00262"></a>00262       p = c;
<a name="l00263"></a>00263       c = c-&gt;getChild(s[j]);
<a name="l00264"></a>00264       <span class="keywordflow">if</span>(c == NULL)
<a name="l00265"></a>00265         {
<a name="l00266"></a>00266           c = p;
<a name="l00267"></a>00267           <span class="keywordflow">break</span>;
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270     <span class="keywordflow">for</span>(; j &gt;= 0; j--) {
<a name="l00271"></a>00271       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l = 0; l &lt; (int)<a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;size(); l++) {
<a name="l00272"></a>00272         ContextTreeNodePtr n = _tree-&gt;createContext();
<a name="l00273"></a>00273         DoubleVector prob;
<a name="l00274"></a>00274         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; n-&gt;alphabet_size(); i++)
<a name="l00275"></a>00275           prob.push_back(exp(c -&gt;getDistribution()-&gt;<a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a1333a6e316ae2f36a12dfdcc6bc41108" title="Returns the log_probability_of the number s.">log_probability_of</a>(i)));
<a name="l00276"></a>00276         DiscreteIIDModelPtr distr = DiscreteIIDModelPtr(<span class="keyword">new</span> DiscreteIIDModel(prob));
<a name="l00277"></a>00277         n-&gt;setDistribution(distr);
<a name="l00278"></a>00278         c-&gt;setChild(n, l);
<a name="l00279"></a>00279       }
<a name="l00280"></a>00280       c = c-&gt;getChild(s[j]);
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     ContextTreeNodePtr current = _tree-&gt;getContext(s,s.size()-1);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     current-&gt;getDistribution()-&gt;log_probability_of(s[s.size()-1], -HUGE);
<a name="l00287"></a>00287     <span class="keywordtype">double</span> sum = 0;
<a name="l00288"></a>00288     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> symbol = 0; symbol &lt; <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;size(); symbol++)
<a name="l00289"></a>00289         {
<a name="l00290"></a>00290             sum += exp(current-&gt;getDistribution()-&gt;log_probability_of(symbol));
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> symbol = 0; symbol &lt; <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;size(); symbol++)
<a name="l00293"></a>00293         {
<a name="l00294"></a>00294             <span class="keywordflow">if</span>(symbol != s[s.size()-1]) {
<a name="l00295"></a>00295                 <span class="keywordtype">double</span> x = exp(current-&gt;getDistribution()-&gt;log_probability_of(symbol));
<a name="l00296"></a>00296                 current-&gt;getDistribution()-&gt;log_probability_of(symbol, log(x/sum));
<a name="l00297"></a>00297             }
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     std::vector &lt;ContextTreeNodePtr&gt; children = current-&gt;getChildren();
<a name="l00302"></a>00302     <span class="keywordflow">if</span>(current-&gt;isLeaf())
<a name="l00303"></a>00303       <span class="keywordflow">return</span>;
<a name="l00304"></a>00304     std::vector &lt;ContextTreeNodePtr&gt; stack;
<a name="l00305"></a>00305     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; (int)children.size(); i++)
<a name="l00306"></a>00306         stack.push_back(children[i]);
<a name="l00307"></a>00307 <span class="preprocessor">#if 1</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>    <span class="keywordflow">while</span>(stack.size() &gt; 0) {
<a name="l00309"></a>00309       current = stack.back();
<a name="l00310"></a>00310       stack.pop_back();
<a name="l00311"></a>00311       <span class="keywordflow">if</span>(current == NULL)
<a name="l00312"></a>00312         <span class="keywordflow">continue</span>;
<a name="l00313"></a>00313       assert(current-&gt;getDistribution() != NULL);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     current-&gt;getDistribution()-&gt;log_probability_of(s[s.size()-1], -HUGE);
<a name="l00318"></a>00318     <span class="keywordtype">double</span> sum = 0;
<a name="l00319"></a>00319     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> symbol = 0; symbol &lt; <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;size(); symbol++)
<a name="l00320"></a>00320         {
<a name="l00321"></a>00321             sum += exp(current-&gt;getDistribution()-&gt;log_probability_of(symbol));
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> symbol = 0; symbol &lt; <a class="code" href="../../d4/d17/classtops_1_1ProbabilisticModel.html#a3448df2312332530193ae688a7cf82a9" title="Returns the alphabet.">alphabet</a>()-&gt;size(); symbol++)
<a name="l00324"></a>00324         {
<a name="l00325"></a>00325             <span class="keywordflow">if</span>(symbol != s[s.size()-1]) {
<a name="l00326"></a>00326                 <span class="keywordtype">double</span> x = exp(current-&gt;getDistribution()-&gt;log_probability_of(symbol));
<a name="l00327"></a>00327                 current-&gt;getDistribution()-&gt;log_probability_of(symbol, log(x/sum));
<a name="l00328"></a>00328             }
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330       <span class="keywordflow">if</span>(current-&gt;isLeaf())
<a name="l00331"></a>00331         <span class="keywordflow">continue</span>;
<a name="l00332"></a>00332       children = current-&gt;getChildren();
<a name="l00333"></a>00333       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; (int)children.size(); i++)
<a name="l00334"></a>00334         stack.push_back(children[i]);
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336 <span class="preprocessor">#endif</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Thu Jun 28 2012 14:40:27 for ToPS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
